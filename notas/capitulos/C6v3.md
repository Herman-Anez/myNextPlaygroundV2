Using a Local Dockerized PostgreSQL Database For The Next.js Tutorial
https://blog.jwink.dev/using-a-local-dockerized-postgresql-database-for-the-next-js-tutorial-fdcc64d78624

I recently found myself starting the official Next.js tutorial after a buddy of mine recently completed it as part of his coursework in the MIT Full Stack Development certificate program. The tutorial itself is great. It is well written, with thorough walk-throughs, helpful quiz questions, and “do-it-yourself” code portions that truly help you learn how to use the framework. It does this by providing just enough boilerplate code that you can get a project up and running but it leaves opening for improvement that it then walks you through as you move through the different chapters.

If you’re like me, when you hit the 6th Chapter of the “App Router” tutorial, you wanted to set up your own local database instead of creating an account and connecting to their Vercel system. In doing so, I ran into some snags with running the code, and so I wanted to put those in a place that was easy to find, “For those who come after.”

Prerequisites

This set up is going to assume that you have an understanding of Docker, compose files, and have the ability to run containerized systems within your local file system; whether that is Windows, Linux, or MacOS.

    Docker installed locally (I used Docker Desktop for Windows)
    Next.js requirements (React, Node, etc…)

Steps With Code

1. Start Docker Hub and run docker-compose up -d from the directory with your docker-compose file. For me, I name the directory something like “local-db-store”.

The below Docker Compose file will create a database named “db” that can be accessed with ther username “postgres” and no password. The like POSTGRES_HOST_AUTH_METHOD: "trust" tells the local system to trust connections without the need to check passwords.

Note: For more information on the below YAML, visit the Postrgres Docker image read.me.

services:
  next_db:
    container_name: next_db
    image: postgres
    restart: always
    environment:
      POSTGRES_DB: "next_db"
      POSTGRES_HOST_AUTH_METHOD: "trust"
      PGDATA: /var/lib/postgresql/18/docker
    ports:
      - "5432:5432"
    volumes:
      - ./data/nextdb/postgres/:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

2. Create your .env.local file within the root directory of your Next.js application. The tutorial mentions using the credentials generated by Vercel, and so we need to update these to match our local system.

# https://nextjs.org/learn/dashboard-app/setting-up-your-database#create-a-postgres-database
POSTGRES_URL="postgres://<your Postgres username>:@127.0.0.1:5432/<your_db_name>"
POSTGRES_URL_NON_POOLING="postgres://<your Postgres username>:@127.0.0.1:5432/<your_db_name>"
POSTGRES_USER="postgres"
POSTGRES_HOST="127.0.0.1"
POSTGRES_PASSWORD=""
POSTGRES_DATABASE="<your_db_name>"

Real Example

POSTGRES_URL="postgres://postgres:@127.0.0.1:5432/next_db"
POSTGRES_URL_NON_POOLING="postgres://postgres:@127.0.0.1:5432/next_db"
POSTGRES_USER="postgres"
POSTGRES_HOST="127.0.0.1"
POSTGRES_PASSWORD=""
POSTGRES_DATABASE="next_db"

3. Update app/lib/data.ts and app/seed/route.ts to remove the requirement of SSL from the database connection.

Original

const sql = postgres(process.env.POSTGRES_URL!, {ssl: 'require'});

New

const sql = postgres(process.env.POSTGRES_URL!);

This is required because we did not enable SSL on our local docker instance. If you were to leave the sql connection line as it was originally written, you would receive the error ECONNRESET.

4. To make the SEED file work, you will need to update the following line to add a ; at the end of the SQL statement, else you will get an error that uuid-ossp already exists even though it has “IF NOT EXISTS”.

Original

await sql`CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`;

New

await sql`CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`;

5. Lastly, start your node application if it isn’t [pnpm dev] and then visit localhost:3000/seed.

You should now have a fully seeded database that reflects throughout the rest of the tutorial as you access data via the web application.

Hopefully you found this helpful. The Next.js tutorial can always change, and you may need to alter things further in order to get this to work for you. If you have any questions, suggestions, or updates, please leave a comment or reach out to me directly.